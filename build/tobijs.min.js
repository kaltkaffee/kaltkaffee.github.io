/*! tobijs 08-04-2016 */
var tobi=tobi||{VERSION:"1.0"};tobi.ShapeType={Rect:1,Circle:2,Polygon:3},function(a){"use strict";function b(a){a.parent instanceof Function&&(b.apply(this,[a.parent]),this["super"]=c(this,d(this,this.constructor))),a.apply(this,arguments)}function c(a,b){for(var c in a)"super"!==c&&a[c]instanceof Function&&!(a[c].prototype instanceof Class)&&(b[c]=a[c]["super"]||d(a,a[c]));return b}function d(a,b){var c=a["super"];return b["super"]=function(){var d=a["super"];a["super"]=c;var e=b.apply(a,arguments);return a["super"]=d,e}}a.Class=function(){},a.Class.extend=function e(a){function d(){b!==arguments[0]&&(b.apply(this,[a]),c(this,this),this.init instanceof Function&&this.init.apply(this),this.constructor.apply(this,arguments))}return d.prototype=new this(b),d.prototype.constructor=d,d.toString=function(){return a.toString()},d.extend=function(b){return b.parent=a,e.apply(d,arguments)},d},a.Class=a.Class.extend(function(){this.constructor=function(){this["super"]&&this["super"]()}})}(this),tobi.Transform=Class.extend(function(){var a=new tobi.Vector(0,0);this.constructor=function(){this.parent=null,this.rotation=0,this.position=new tobi.Vector(0,0),this.scale=new tobi.Vector(1,1),this.angle=0,this.matrix=new tobi.Matrix,this.worldPosition=new tobi.Vector(0,0),this.worldScale=new tobi.Vector(1,1),this.worldRotation=0,this.origin=new tobi.Vector(0,0),this.bounds=new tobi.BoundingBox(0,0,1,1),this.globalBounds=new tobi.BoundingBox(0,0,1,1),this.rotation=0},this.updateTransform=function(){var b,c,d,e,f,g,h=this.matrix,i=this.parent.matrix;this.rotation=this.angle*tobi.Math.degToRad,this.rotation%tobi.Math.PI2?(this.rotation!==this._oldRotation&&(this._oldRotation=this.rotation,a.y=Math.sin(this.rotation),a.x=Math.cos(this.rotation)),b=a.x*this.scale.x,c=a.y*this.scale.x,d=-a.y*this.scale.y,e=a.x*this.scale.y,f=this.position.x,g=this.position.y,f-=this.origin.x*b+this.origin.y*d,g-=this.origin.x*c+this.origin.y*e,h.a=b*i.a+c*i.c,h.b=b*i.b+c*i.d,h.c=d*i.a+e*i.c,h.d=d*i.b+e*i.d,h.x=f*i.a+g*i.c+i.x,h.y=f*i.b+g*i.d+i.y):(b=this.scale.x,e=this.scale.y,f=this.position.x,g=this.position.y,f-=this.origin.x*b,g-=this.origin.y*e,h.a=b*i.a,h.b=b*i.b,h.c=e*i.c,h.d=e*i.d,h.x=f*i.a+g*i.c+i.x,h.y=f*i.b+g*i.d+i.y),this.worldPosition.set(h.x,h.y),this.worldScale.set(Math.sqrt(h.a*h.a+h.b*h.b),Math.sqrt(h.c*h.c+h.d*h.d)),this.worldRotation=Math.atan2(-h.c,h.d)},this.destroyTransform=function(){delete this.position,delete this.scale,delete this.matrix,delete this.worldPosition,delete this.worldScale,delete this.origin,delete this.bounds,delete this.globalBounds}}),tobi.Hierarchy=tobi.Transform.extend(function(){this.children=[],this.constructor=function(){this["super"]()},this.addChild=function(a){return this.addChildAt(a,this.children.length)},this.addChildAt=function(a,b){if(b>=0&&b<=this.children.length)return a.parent&&a.parent.removeChild(a),a.parent=this,this.children.splice(b,0,a),this._changeDepth=!0,a;throw new Error(a+"addChildAt: The index "+b+" supplied is out of bounds "+this.children.length)},this.removeChild=function(a){var b=this.children.indexOf(a);if(-1!==b)return this.removeChildAt(b)},this.removeChildAt=function(a){var b=this.getChildAt(a);return b.parent=void 0,this.children.splice(a,1),b},this.getChildAt=function(a){if(0>a||a>=this.children.length)throw new Error("getChildAt: Supplied index "+a+" does not exist in the child list, or the supplied DisplayObject must be a child of the caller");return this.children[a]},this.preUpdate=function(a){for(var b=0;b<this.children.length;b++)this.children[b].preUpdate(a)},this.update=function(){for(var a=0;a<this.children.length;a++)this.children[a].update()},this._updateTransform=function(){for(var a=0;a<this.children.length;a++)this.children[a]._updateTransform()},this.render=function(){for(var a=0;a<this.children.length;a++)this.children[a].render(this.game.context)}}),tobi.Instance=tobi.Hierarchy.extend(function(){this.game=null,this.name="instance",this.z=0,this.depth=0,this.visible=!0,this.active=!0,this._selfDestroy=!1,this._changeDepth=!1;var a=!1;this.constructor=function(a,b,c){this["super"](),this.game=a,this.name=c},this.preUpdate=function(a){if(this.active){this.component.animation&&this.component.animation.update(a);for(var b=0;b<this.children.length;b++)this.children[b].z=b,this.children[b].preUpdate(a)}},this._updateTransform=function(){if(this.active&&!this._selfDestroy){this.updateTransform(),this.component.render?this.bounds.setByGameObject(this,!1):this.bounds.setByPosition(this.position);var a=1/0,b=1/0,c=-(1/0),d=-(1/0);"_world"!=this.name&&(a=this.bounds.min.x,b=this.bounds.min.y,c=this.bounds.max.x,d=this.bounds.max.y);for(var e=0;e<this.children.length;e++){this.children[e]._updateTransform(),this.children[e].z=e;var f=this.children[e].bounds;a=a<f.min.x?a:f.min.x,b=b<f.min.y?b:f.min.y,c=c>f.max.x?c:f.max.x,d=d>f.max.y?d:f.max.y}this.globalBounds.set(a,b,c,d)}},this.render=function(a){if(this.visible&&!this._selfDestroy&&(this.component.render&&this.game.camera.view.intersects(this.bounds.box)&&(this.component.render.render(a),this.game.camera.instancesInView++),this.freelyrender&&(a.setTransform(1,0,0,1,0,0),this.freelyrender(a)),0!==this.children.length))for(var b=0;b<this.children.length;)this.children[b].render(a),b++},this._updateDepth=function(){this.children.sort(function(a,b){return a.depth>b.depth?1:a.depth<b.depth?-1:a.z>b.z?1:-1}),this._changeDepth=!1},this.setDepth=function(a){this.depth=a,this._changeDepth=!0},this.setActive=function(a){void 0===a&&(a=!0),this.visible=a,this.active=a},this.destroy=function(b){void 0===b&&(b=!1),this._selfDestroy=!0,a=b},this._garbage=function(){a?this._poolBack():this._destroy()},this._destroy=function(){if(null!==this.game){this._selfDestroy=!0,this.onDestroy&&this.onDestroy(),this.parent&&this.parent.removeChild(this),this.component.collider&&this.game.physics.removeColliderObj(this.component.collider),this.removeAllComponents(),this.destroyTransform();for(var a=this.children.length;a--;)this.children[a]._destroy();this.setActive(!1),this.game=null,this.parent=null}},this.destroyAllChilds=function(){for(var a=this.children.length;a--;)this.children[a]._destroy()},this._poolBack=function(a){null==this.pool&&(this.pool=this.name),void 0===a&&(a=!0),this.parent&&this.parent.removeChild(this),this.parent=null,a&&this.onDestroy&&this.onDestroy(),this.component.collider&&this.game.physics.removeColliderObj(this.component.collider),this.game.pool.pushBack(this);for(var b=this.children.length;b--;)this.children[b]._poolBack(a)}}),Object.defineProperty(tobi.Instance.prototype,"length",{get:function(){return this.children.length}}),tobi.Canvas={create:function(a,b,c){var d,e={width:b,height:c,id:Math.random().toString(36).substr(2,9),"class":"",container:"body",style:"padding: 0;margin: auto;display: block;top: 0; bottom: 0;left: 0;right: 0;border:1px solid #d3d3d3;background-color: #f1f1f1;"},f=e;return d=document.createElement("canvas"),d.setAttribute("id",f.id),d.setAttribute("width",f.width),d.setAttribute("height",f.height),d.setAttribute("style",f.style),this.appendDOM(d,a),d},appendDOM:function(a,b){b&&("string"==typeof b?target=document.getElementById(b):"object"==typeof b&&1===b.nodeType&&(target=b)),target||(target=document.body),target.appendChild(a)}},tobi.CanvasBuffer=function(a,b){this.width=a,this.height=b,this.canvas=tobi.CanvasList.create(this,this.width,this.height),this.context=this.canvas.getContext("2d"),this.canvas.width=a,this.canvas.height=b},tobi.CanvasBuffer.prototype.constructor=tobi.CanvasBuffer,tobi.CanvasBuffer.prototype.clear=function(){this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.width,this.height)},tobi.CanvasBuffer.prototype.resize=function(a,b){this.width=this.canvas.width=a,this.height=this.canvas.height=b},tobi.CanvasBuffer.prototype.destroy=function(){tobiJS.CanvasList.remove(this)},tobi.CanvasList={create:function(a,b,c){var d,e=tobi.CanvasList.first();if(-1===e){var f={parent:a,canvas:document.createElement("canvas")};tobi.CanvasList.list.push(f),d=f.canvas}else tobi.CanvasList[e].parent=a,d=tobiJS.CanvasList[e].canvas;return void 0!==b&&(d.width=b,d.height=c),d},appendDOM:function(){},filter:function(a){var b=tobi.CanvasList.list;return b.parent===a},first:function(){for(var a=tobi.CanvasList.list,b=0;b<a.length;b++)if(null===a[b].parent)return b;return-1},remove:function(a){for(var b=tobi.CanvasList.list,c=0;c<b.length;c++)b[c].parent===a&&(b[c].parent=null)}},tobi.CanvasList.list=[],tobi.Animation=function(a){this.source=a,this.frames=[]},tobi.Animation.prototype={addFrame:function(a,b,c,d){this.frames.push(new tobi.Rect(a,b,c,d))},addStrip:function(a,b,c,d,e,f){for(var g=0,h=0,i=0;e>i;i++)this.addFrame(a+c*h,b+d*g,c,d),h++,i%f==f-1&&(h=0,g++)},duplicateFrame:function(a,b){void 0===b?this.frames.push(this.frames[a]):this.frames.splice(b,0,this.frames[a])},getFrame:function(a){return this.frames[a]}},Object.defineProperty(tobi.Animation.prototype,"length",{get:function(){return this.frames.length}}),tobi.AnimationCache=function(a){this.game=a,this.map=new tobi.Multimap},tobi.AnimationCache.prototype={add:function(a,b,c){var d=this.game.cache.getAsset("images",a);if(null==d)return console.warn("tobiJS.animationCache: Can not create Animation: sprite: "+a),null;var e=new tobi.Animation(d);return this.map.set(b,c,e)},get:function(a,b){return this.map.getValue(a,b)}},tobi.AnimationControl=function(a){this.game=a,this.animations={},this.currentAnimation=null,this.loop=!1,this.isPlaying=!1,this.isPaused=!0,this.currentFrame=0,this._gameObject=null,this._currentAnimObj=null,this.frameSpeed=1},tobi.AnimationControl.prototype={add:function(a,b){return this.animations[a]=new tobi.Animation(a,b)},addFromCache:function(a,b){var c=this.game.animationCache.get(a,b);return c?(this.animations[b]=c,null==this.currentAnimation&&this.setState(b),c):null},remove:function(a){this.animations[a]&&delete this.animations[a]},setState:function(a){this.animations[a]&&(this.currentAnimation=a,this._currentAnimObj=this.animations[a],this.setFrame(0,!0))},setFrame:function(a,b){void 0===b&&(b=!0),a>=this._currentAnimObj.length?a=this._currentAnimObj.length-1:0>a&&(a=0),this.currentFrame=a,this._gameObject.component.render.setFrameRect(this._currentAnimObj.getFrame(this.currentFrame)),this._gameObject.component.render.setImage(this._currentAnimObj.source),b&&(this._timer=0)},setSpeed:function(a){this.frameSpeed=a},play:function(a){this.loop=a,this.isPlaying=!0,this.isPaused=!1},pause:function(){this.isPaused=!0},stop:function(){this.isPaused=!0,this.currentFrame=0,this.setFrame(this.currentFrame)},update:function(a){this.isPaused||null==this._currentAnimObj||(this._timer+=a*this.frameSpeed,this._timer>=this.game.clock.timeStep_mili&&(this._timer=0,this.currentFrame+1<this._currentAnimObj.length?this.currentFrame++:(this.currentFrame=0,this.loop||(this.isPaused=!0),this._gameObject.onAnimationEnd&&this._gameObject.onAnimationEnd()),this.setFrame(this.currentFrame,!1)))}},tobi.Collider=Class.extend(function(){this.shape=null,this.isTrigger=!1,this.bounds=null,this.offset=null,this._gameObject=null,this.position=null;var a=(new tobi.Vector(1,1),0);this.constructor=function(a){this.position=new tobi.Vector,this.offset=new tobi.Vector,this.bounds=new tobi.BoundingBox(0,0,1,1),this.setShape(a)},this.setShape=function(a){this.shape=a,this._updateBounds()},this.setPosition=function(a){this.position.x=a.x-this.shape.centroid.x+this.offset.x,this.position.y=a.y-this.shape.centroid.y+this.offset.y,this.bounds.box.x=this.bounds.min.x+this.position.x,this.bounds.box.y=this.bounds.min.y+this.position.y},this.scale=function(a){if("Polygon"==this.shape.getType()){for(var b=this.shape.getPoints(),c=0;c<b.length;c++)b[c].scale(a.x,a.y);this.shape._recalc()}this._updateBounds()},this.rotate=function(a){if("Polygon"==this.shape.getType()){for(var b=this.shape.getPoints(),c=this.shape.centroid,d=0;d<b.length;d++)b[d].rotateAround(a,c);this.shape._recalc(),this._updateBounds()}},this._updateBounds=function(){this.bounds.setByShape(this.shape)},this.update=function(){var b=!1;a!=this._gameObject.rotation&&(this.rotate(this._gameObject.rotation-a),a=this._gameObject.rotation,b=!0),this.setPosition(this._gameObject.position)},this.debugDraw=function(a,b){void 0===b&&(b="red");var c=this.shape.getPoints(),d=c.length;this.bounds.x,this.bounds.y;for(a.setTransform(1,0,0,1,0,0),a.fillStyle=b,a.save(),a.translate(this.position.x,this.position.y),a.beginPath(),a.moveTo(c[0].x,c[0].y);d--;)a.lineTo(c[d].x,c[d].y);a.closePath(),a.fill(),a.fillStyle="black",a.fillRect(this.shape.centroid.x-2,this.shape.centroid.y-2,4,4),a.restore(),a.strokeStyle="lime",a.strokeRect(this.bounds.box.x,this.bounds.box.y,this.bounds.box.width,this.bounds.box.height)}}),tobi.GameComponents=function(a){this.game=a},tobi.GameComponents.prototype={sprite:function(a){var b;return b=void 0===a?null:this.game.cache.getAsset("images",a),new tobi.Sprite(b)},tiledSprite:function(a){var b=this.game.cache.getAsset("images",a[0]);return null==b?(console.warn("tobiJS.component: Can not create Component: tiledsprite: "+a[0]),null):new tobi.TiledSprite(b,a[1],a[2])},animationControl:function(){return new tobi.AnimationControl(this.game)},collider:function(a){var b,c=a[0];"triangle"==c?b=tobi.Polygon.makeTriangle(a[1],a[2]):"rectangle"==c&&(b=tobi.Polygon.makeRectangle(a[1],a[2]));var d=new tobi.Collider(b);return d},body:function(a,b,c){}},tobi.GameComponents.prototype.constructor=tobi.GameComponents,tobi.RenderType={Sprite:1,TiledSprite:2,CSSText:3},tobi.Renderable=Class.extend(function(){this._gameObject=null,this.constructor=function(){this.type=null,this.source=null,this.frame=new tobi.Rect(0,0,1,1),this.alpha=1},this.setFrameRect=function(a){this.frame=a},this.setFrame=function(a,b,c,d){this.frame.set(a,b,c,d)},this.setImage=function(a,b){void 0===b&&(b=!1),this.source!=a&&(this.source=a),b&&this.setFrame(0,0,this.source.width,this.source.height)},this.render=function(a){if(null!=this.source){var b=1,c=this._gameObject.matrix,d=this._gameObject.origin,e=d.x*-this.frame.width/b,f=d.y*-this.frame.height/b;a.setTransform(c.a,c.b,c.c,c.d,c.x*b,c.y*b),a.globalAlpha=this.alpha,a.drawImage(this.source,this.frame.x,this.frame.y,this.frame.width,this.frame.height,e,f,this.frame.width/b,this.frame.height/b)}}}),tobi.Sprite=tobi.Renderable.extend(function(){this.constructor=function(a){this["super"](),this.type=tobi.RenderType.Sprite,this.source=a,null!=a&&this.setFrame(0,0,a.width,a.height)},this.setSprite=function(a){var b=this._gameObject.game.cache.getAsset("images",a);null!=b&&this.setImage(b)}}),tobi.Text=tobi.Renderable.extend(function(){this.constructor=function(a,b){this["super"](),this.type=tobi.RenderType.CSSText,this.bounds=0,this.canvas=tobi.CanvasList.create(this),this.context=this.canvas.getContext("2d"),this.texture=new tobi.Texture,this.fontStyle="12px Verdana",this.strokeColor="black",this.color="white",this.text=a,this.style=null,this.fontObj=null,this.setStyle(b)},this.setStyle=function(a){a=a||{},a.font=a.font||"20px Verdana",a.backgroundColor=a.backgroundColor||null,a.fill=a.fill||"black",a.align=a.align||"left",a.boundsAlignH=a.boundsAlignH||"left",a.boundsAlignV=a.boundsAlignV||"top",a.stroke=a.stroke||"black",a.strokeThickness=a.strokeThickness||0,a.wordWrap=a.wordWrap||!1,a.wordWrapWidth=a.wordWrapWidth||100,a.shadowOffsetX=a.shadowOffsetX||0,a.shadowOffsetY=a.shadowOffsetY||0,a.shadowColor=a.shadowColor||"rgba(0,0,0,0)",a.shadowBlur=a.shadowBlur||0,a.tabs=a.tabs||0;var b=this.checkFont(a.font);a.fontStyle&&(b.fontStyle=a.fontStyle),a.fontVariant&&(b.fontVariant=a.fontVariant),a.fontWeight&&(b.fontWeight=a.fontWeight),a.fontSize&&("number"==typeof a.fontSize&&(a.fontSize=a.fontSize+"px"),b.fontSize=a.fontSize),this.fontObj=b,this.style=a},this.checkFont=function(a){var b=a.match(/^\s*(?:\b(normal|italic|oblique|inherit)?\b)\s*(?:\b(normal|small-caps|inherit)?\b)\s*(?:\b(normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit)?\b)\s*(?:\b(xx-small|x-small|small|medium|large|x-large|xx-large|larger|smaller|0|\d*(?:[.]\d*)?(?:%|[a-z]{2,5}))?\b)\s*(.*)\s*$/);return b?{font:a,fontStyle:b[1]||"normal",fontVariant:b[2]||"normal",fontWeight:b[3]||"normal",fontSize:b[4]||"medium",fontFamily:b[5]}:void 0},this.updateText=function(){for(var a=0,b=this.text,c=b.split(/(?:\r\n|\r|\n)/),d=this.style.tabs,e=[],a=0,f=this.determineFontProperties(this.style.font),g=0;g<c.length;g++){if(0===d){var h=this.context.measureText(c[g]).width+this.style.strokeThickness+this.padding.x;this.style.wordWrap&&(h-=this.context.measureText(" ").width)}else{var i=c[g].split(/(?:\t)/),h=this.padding.x+this.style.strokeThickness;if(Array.isArray(d))for(var j=0,k=0;k<i.length;k++){var l=Math.ceil(this.context.measureText(i[k]).width);k>0&&(j+=d[k-1]),h=j+l}else for(var k=0;k<i.length;k++)h+=Math.ceil(this.context.measureText(i[k]).width),h+=diff}e[g]=Math.ceil(h),a=Math.max(a,e[g])}this.canvas.width=a;var m=f.fontSize+this.style.strokeThickness+this.padding.y,n=m*c.length,o=this._lineSpacing;0>o&&Math.abs(o)>m&&(o=-m),0!==o&&(n+=o*c.length),this.canvas.height=n,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.style.backgroundColor&&(this.context.fillStyle=this.style.backgroundColor,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)),this.context.fillStyle=this.style.fill,this.context.font=this.style.font,this.context.strokeStyle=this.style.stroke,this.context.textBaseline="alphabetic",this.context.lineWidth=this.style.strokeThickness,this.context.lineCap="round",this.context.lineJoin="round"},this.render=function(a){}}),tobi.TiledSprite=tobi.Renderable.extend(function(){this.constructor=function(a,b,c){this["super"](),this.type=tobi.RenderType.TiledSprite,this.source=a,this.setFrame(0,0,b,c),this.tilePosition=new tobi.Vector(0,0),this.tileScale=new tobi.Vector(1,1),this.offset=new tobi.Vector(1,1),this.tilePattern=null,this.refresh=!0,this.canvasBuffer=null,this.tiledTexture=null},this.render=function(a){var b=this._gameObject.matrix,c=this._gameObject.origin,d=1;if(a.setTransform(b.a,b.b,b.c,b.d,b.x*d,b.y*d),this.refresh){if(this.createTilling(),!this.tiledTexture)return;this.tilePattern=a.createPattern(this.tiledTexture.source,"repeat")}var e=this.tilePosition,f=this.tileScale;e.x%=this.tiledTexture.source.width,e.y%=this.tiledTexture.source.height,a.scale(f.x,f.y),a.translate(e.x+c.x*-this.frame.width,e.y+c.y*-this.frame.height),a.fillStyle=this.tilePattern,a.globalAlpha=this.alpha;var g=-e.x,h=-e.y,i=this.frame.width/f.x,j=this.frame.height/f.y;a.fillRect(g,h,i,j),a.scale(1/f.x,1/f.y),a.translate(-e.x+c.x*this.frame.width,-e.y+c.y*this.frame.height),this.refresh=!1},this.createTilling=function(){var a=(this.source,this.source.width),b=this.source.height;this.canvasBuffer?(this.canvasBuffer.resize(a,b),this.tiledTexture.width=a,this.tiledTexture.height=b,this.tiledTexture.needsUpdate=!0):(this.canvasBuffer=new tobi.CanvasBuffer(a,b),this.tiledTexture=tobi.Texture.createFromCanvas(this.canvasBuffer.canvas),this.tiledTexture.isTiling=!0,this.tiledTexture.needsUpdate=!0),this.canvasBuffer.context.drawImage(this.source,0,0,a,a)}}),tobi.Cache=function(a){this.game=a,this._cache={images:{},sounds:{}}},tobi.Cache.prototype={addImage:function(a,b,c){this.tagExists("images",a)&&this.removeTagAt("images",a);var d={tag:a,url:b,data:c};this._cache.images[a]=d},addSound:function(a,b,c,d){var e=!1;d||(e=!0);var f={tag:a,url:b,data:c,usingWebAudio:d,decoded:e,isDecoding:!1};this._cache.sounds[a]=f},soundDecoded:function(a,b){var c=this.getAssetInfo("sounds",a);c.data=b,c.decoded=!0,c.isDecoding=!1},tagExists:function(a,b){return!!this._cache[a][b]},removeTagAt:function(a,b){delete this._cache[a][b]},getAsset:function(a,b){if(this.tagExists(a,b)){var c=this._cache[a][b];return c.data}return null},getAssetInfo:function(a,b){if(this.tagExists(a,b)){var c=this._cache[a][b];return c}return null},clear:function(){for(var a in this._cache)for(var b in this._cache[a])delete this._cache[a][b]}},function(){function a(){function d(){return this.init.apply(this,arguments),this}for(var e={},f=new Array(arguments.length),g=0;g<arguments.length;g++)f.push(arguments[g]);if(d.prototype=Object.create(this.prototype),f.forEach(function(a){b(d,e,a.__methods__||a)}),!("init"in d.prototype))throw new TypeError("extend: Class is missing a constructor named `init`");return Object.defineProperty(d.prototype,"_superClass",{value:this.prototype}),Object.defineProperty(d.prototype,"_super",{value:c}),Object.defineProperty(d,"__methods__",{value:e}),d.extend=a,d}function b(a,b,c){Object.keys(c).forEach(function(d){if(b[d]=c[d],"function"!=typeof c[d])throw new TypeError("extend: Method `"+d+"` is not a function");Object.defineProperty(a.prototype,d,{configurable:!0,value:c[d]})})}function c(a,b,c){return a.prototype[b].apply(this,c)}var d=function(){Object.apply(this,arguments)};d.prototype=Object.create(Object.prototype),d.prototype.constructor=d,Object.defineProperty(d,"extend",{value:a}),tobi.Class=d}(),tobi.Dispatcher=Class.extend(function(){this.dispatch=function(){}}),tobi.Game=function(a,b,c,d,e){return this.parent="body",this.width=800,this.height=600,this.config=null,this.systemInited=!1,this.isRunning=!1,this.debugMode=!1,this.timeMode=!1,this._spiraling=0,this._lastFrameCount=0,this.debug=null,this.cache=null,this.load=null,this.canvas=null,this.scene=null,this.sound=null,this.draw=null,this.universe=null,this.world=null,this.input=null,this.clock=null,this.component=null,this.instance=null,this.animationCache=null,this.updateGameMethod=null,this.pool=null,this.context=null,1===arguments.length&&"object"==typeof arguments[0]?this.parseConfiguration(arguments[0]):("undefined"!=typeof a&&(this.width=a),"undefined"!=typeof b&&(this.height=b),"undefined"!=typeof d&&(this.timeMode=d),"undefined"!=typeof e&&(this.debugMode=e)),this.init(),this},tobi.Game.prototype={parseConfiguration:function(a){this.config=a,a.debug&&(this.debugMode=a.debug),a.width&&(this.width=a.width),a.height&&(this.height=a.height),a.parent&&(this.parent=a.parent)},init:function(){this.systemInited||(this.canvas=tobi.Canvas.create(this.parent,this.width,this.height),this.context=this.canvas.getContext("2d",{alpha:!1}),this.cache=new tobi.Cache(this),this.load=new tobi.LoadManager(this),this.clock=new tobi.Clock(this),this.universe=new tobi.Universe(this),this.world=new tobi.World(this),this.draw=new tobi.Draw(this),this.scene=new tobi.SceneManager(this),this.input=new tobi.Input(this),this.instance=new tobi.Creator(this,this.world),this.component=new tobi.GameComponents(this),this.animationCache=new tobi.AnimationCache(this),this.sound=new tobi.SoundManager(this),this.pool=new tobi.Pool(this),this.physics=new tobi.Physics(this),this.debugMode&&(this.debug=new tobi.Debug(this)),this.clock.start(),this.input.init(),this.sound.start(),this.world.start(),this.updateGameMethod=new tobi.UpdateGame(this,this.timeMode),this.updateGameMethod.start(),this.systemInited=!0,this.isRunning=!0,console.log("tobiJS Created!"))},update:function(a){if(this.systemInited)if(this.clock.update(a),this._spiraling>1)this.clock.deltaTime=0,this._spiraling=0,this.clock.accumalator=0,this.render();else{for(var b=0;this.clock.accumalator>=this.clock.accumulatorDelta;)if(this.clock.deltaTime=Math.min(this.clock.accumalator,this.clock.accumulatorDelta)/1e3,this.logic(this.clock.deltaTime),this.clock.accumalator-=this.clock.accumulatorDelta,b++,this.clock.refresh(),b>=240){this.clock.accumalator=0;break}b>this._lastFrameCount?this._spiraling++:b<this._lastFrameCount&&(this._spiraling=0),this._lastFrameCount=b,this.render(this.clock.accumalator/this.clock.accumulatorDelta)}},logic:function(a){this.scene.preUpdate(),this.scene.update(a),this.input.update(),this.universe.preUpdate(a),this.universe.update(a),this.physics.update(),this.sound.update(),this.universe._updateTransform()},render:function(a){this.context.setTransform(1,0,0,1,0,0),this.context.globalCompositeOperation="source-over",this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.fillStyle=this.universe.backgroundColor,this.context.fillRect(0,0,this.canvas.width,this.canvas.height),this.scene.render(),this.universe.render(),null!=this.debug&&(this.context.setTransform(1,0,0,1,0,0),this.debug.test())},destroy:function(){this.updateGameMethod.destroy(),this.physics.destroy(),this.universe.destroy(),this.sound.destroy(),this.input.destroy(),this.debug=null,this.cache=null,this.load=null,this.canvas=null,this.scene=null,this.sound=null,this.draw=null,this.universe=null,this.world=null,this.input=null,this.clock=null,this.component=null,this.instance=null,this.animationCache=null,this.updateGameMethod=null}},tobi.Game.prototype.constructor=tobi.Game,tobi.LoadManager=function(a){this.game=a,this.cache=a.cache,this._fileQueue=[],this._fileCount=0,this._fileLoadedCount=0,this._fileErrorCount=0,this.isDownloading=!1,this.progress=0},tobi.LoadManager.prototype={queueAsset:function(a,b,c,d){var e={type:a,tag:b,url:c,data:null,loaded:!1,error:!1,loading:!1};if(d)for(var f in d)e[f]=d[f];var g=this.getAssetQueueIndex(a,b);if(g>-1){var h=this._fileQueue[g];h.loading||h.loaded?(this._fileQueue.push(e),this._fileCount++):this._fileQueue[g]=e}else-1===g&&(this._fileQueue.push(e),this._fileCount++)},image:function(a,b){this.queueAsset("image",a,b)},audio:function(a,b){this.queueAsset("audio",a,b,{buffer:null,autoDecode:!0})},getAssetQueueIndex:function(a,b){for(var c=-1,d=0;d<this._fileQueue.length;d++){var e=this._fileQueue[d];if(e.type===a&&e.name===b&&(c=d,!e.loaded&&!e.loading))break}return c},reset:function(){this.isDownloading=!1,this._fileCount=0,this._fileLoadedCount=0,this._fileQueue.length=0,this._fileErrorCount=0,this.progress=0},startDownload:function(){this.isDownloading||(this.isDownloading=!0,this.processFileQueue())},endDownload:function(){this.isDownloading=!1,this.updateProgress(),this.game.scene.preloadComplete()},processFileQueue:function(){for(var a=0;a<this._fileQueue.length;a++){var b=this._fileQueue[a];b.loading=!0,this.downloadFile(b)}},downloadFile:function(a){switch(a.type){case"image":this.loadImageFile(a);break;case"audio":this.game.sound.webAudio&&this.loadAudioFile(a)}},loadImageFile:function(a){var b=this;a.data=new Image,a.data.name=a.tag,a.data.addEventListener("load",function(){b.fileLogComplete(a)},!1),a.data.addEventListener("error",function(){b.fileLogError(a)},!1),a.data.src=a.url},loadAudioFile:function(a){var b=this,c=new XMLHttpRequest;c.open("GET",a.url,!0),c.responseType="arraybuffer",c.onload=function(){4==c.readyState&&c.status>=400&&c.status<=599?b.fileLogError(a):b.fileLogComplete(a,c)},c.onerror=function(){b.fileLogError(a)},c.send()},fileLogError:function(a){console.warn("tobiJS.load: Error to load asset from "+a.url),this.dowloadComplete(a,!0)},fileLogComplete:function(a,b){switch(a.type){case"image":this.cache.addImage(a.tag,a.url,a.data);break;case"audio":a.data=b.response,this.cache.addSound(a.tag,a.url,a.data,!0),a.autoDecode&&this.game.sound.decode(a.tag)}this.dowloadComplete(a,!1)},dowloadComplete:function(a,b){1==b?(a.error=!0,this._fileErrorCount++):(a.loaded=!0,this._fileLoadedCount++),this.updateProgress(),this.downloadIsDone()&&this.endDownload()},downloadIsDone:function(){return this._fileQueue.length==this._fileLoadedCount+this._fileErrorCount},updateProgress:function(){var a=0;0!=this._fileCount&&(a=parseFloat(this._fileLoadedCount)/parseFloat(this._fileCount)),this.progress=a},totalQueuedFiles:function(){return this._fileCount-this._fileLoadedCount}},tobi.LoadManager.prototype.constructor=tobi.LoadManager,tobi.Scene=function(a){var b=null;b="undefined"==typeof a?null:a,this.game=b,this.camera=null,this.x=0,this.y=0,this.width=0,this.height=0,this.view=0,null!=b&&(this.width=b.width,this.height=b.height)},tobi.Scene.prototype={preload:function(){},loading:function(){},loadingRender:function(){},start:function(){},update:function(){},render:function(){},destroy:function(){},_update:function(){},_draw:function(){self.game.context.font="12px Verdana",self.game.context.fillText("FPS: "+Math.round(this.game.clock.fps)+" / 60",0,12),self.game.context.fillText("Instances Count: "+this.instances.length,0,24),self.game.context.fillText("Instances in view: "+this.view,0,36)},instanceDestroy:function(a){a.destroy&&a.destroy();var b=this.instances.indexOf(a);this.instances.splice(b,1)},addGameObject:function(a,b){var c,d=!1;return 0==arguments.length?c=new tobi.GameObject:(d=void 0===b?!1:b,c=d?a.clone():a),c._id=this.instances.length,c._game=this.game,this.instances.push(c),c.start(),c}},tobi.Scene.prototype.constructor=tobi.Scene,tobi.Scene.prototype.setBounds=function(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d},tobi.SceneManager=function(a){this.game=a,this.scenes={},this.current_scene_name="",this.change_scene=null,this._setup=!1,this._clearCache=!1,this.current_scene=null,this.onStartCallback=null,this.onLoadingCallback=null,this.onLoadingRenderCallback=null,this.onPreloadCallback=null,this.onUpdateCallback=null,this.onRenderCallback=null,this.onDestroyCallback=null},tobi.SceneManager.prototype={add:function(a,b){var c;tobi.Scene.prototype.isPrototypeOf(b)?(c=b,c.game=this.game):c=null,null!=c&&(this.scenes[a]=c)},set:function(a,b){void 0===b&&(b=!1),this.change_scene=a,this._clearCache=b},restart:function(a){void 0===a&&(a=!1),this.change_scene=this.current_scene_name,this._clearCache=a},remove:function(a){this.current_scene_name===a&&(this.current_scene=null,this.onStartCallback=null,this.onLoadingCallback=null,this.onLoadingRenderCallback=null,this.onPreloadCallback=null,this.onUpdateCallback=null,this.onRenderCallback=null,this.onDestroyCallback=null),delete this.scenes[a]},setupScene:function(a){this.current_scene=this.scenes[a],this.onStartCallback=this.scenes[a].start||null,this.onLoadingCallback=this.scenes[a].loading||null,this.onLoadingRenderCallback=this.scenes[a].loadingRender||null,this.onPreloadCallback=this.scenes[a].preload||null,this.onUpdateCallback=this.scenes[a].update||null,this.onRenderCallback=this.scenes[a].render||null,this.onDestroyCallback=this.scenes[a].destroy||null,this.current_scene_name=a,this.game.clock.refresh(),this.current_scene.camera=this.game.world.camera,this.game.instance.scene=this.current_scene,this._setup=!1},clearCurrentScene:function(){this.current_scene_name&&(this.onDestroyCallback&&this.onDestroyCallback.call(this.current_scene,this.game),this._clearCache&&this.game.cache.clear(),this.game.world.destroyAllChilds())},preUpdate:function(){if(this.game.systemInited&&null!=this.change_scene){if(this.clearCurrentScene(),this.setupScene(this.change_scene),this.current_scene_name!==this.change_scene)return;this.change_scene=null,this.onPreloadCallback?(this.game.load.reset(),this.onPreloadCallback.call(this.current_scene,this.game),0===this.game.load.totalQueuedFiles()?this.preloadComplete():this.game.load.startDownload()):this.preloadComplete()}},preloadComplete:function(){this._setup===!1&&this.onLoadingCallback&&this.onLoadingCallback.call(this.current_scene,this.game),this._setup===!1&&this.onStartCallback?(this._setup=!0,this.onStartCallback.call(this.current_scene,this.game)):this._setup=!0},update:function(){this._setup?(this.onUpdateCallback&&this.onUpdateCallback.call(this.current_scene,this.game),this.current_scene._update()):this.onLoadingCallback&&this.onLoadingCallback.call(this.current_scene,this.game)},render:function(){this._setup?this.onRenderCallback&&this.onRenderCallback.call(this.current_scene,this.game):this.onLoadingRenderCallback&&this.onLoadingRenderCallback.call(this.current_scene,this.game)}},tobi.SceneManager.prototype.constructor=tobi.SceneManager,tobi.BoundingBox=function(a,b,c,d){this.center=new tobi.Vector(a+c/2,b+d/2),this.size=new tobi.Vector(c,d),this.min=new tobi.Vector(a,b),this.max=new tobi.Vector(a+c,b+d),this.box=new tobi.Rect(a,b,c,d)},tobi.BoundingBox.prototype={
set:function(a,b,c,d){this.min.set(a,b),this.max.set(c,d),this.box.set(this.min.x,this.min.y,this.max.x-this.min.x,this.max.y-this.min.y),this.center.x=(this.max.x-this.min.x)/2,this.center.y=(this.max.y-this.min.y)/2},setup:function(a,b,c,d,e,f){var g=[],h=1,i=1;b.x<0&&(h=-1),b.y<0&&(i=-1),this.size.x=e*b.x*h,this.size.y=f*b.y*i,d.x*=b.x*h,d.y*=b.y*i,a.x-=d.x,a.y-=d.y,d.x+=a.x,d.y+=a.y;var j=null;j=c instanceof tobi.Vector?this.calcCoordsCosSin:this.calcCoords,g[0]=j(a.x,a.y,d,c),g[1]=j(a.x+this.size.x,a.y,d,c),g[2]=j(a.x,a.y+this.size.y,d,c),g[3]=j(a.x+this.size.x,a.y+this.size.y,d,c),this.min.x=Math.min(g[0].x,g[1].x,g[2].x,g[3].x),this.min.y=Math.min(g[0].y,g[1].y,g[2].y,g[3].y),this.max.x=Math.max(g[0].x,g[1].x,g[2].x,g[3].x),this.max.y=Math.max(g[0].y,g[1].y,g[2].y,g[3].y),this.center.x=a.x+(this.max.x-this.min.x)/2,this.center.y=a.y+(this.max.y-this.min.y)/2,this.box.set(this.min.x,this.min.y,this.max.x-this.min.x,this.max.y-this.min.y)},setByGameObject:function(a,b){if(b)this.setup(a.position,a.scale,a._cosSin,a.render.origin,a.render.width,a.render.height);else{var c=a.component.render.frame,d={x:a.worldPosition.x,y:a.worldPosition.y},e={x:a.origin.x*c.width,y:a.origin.y*c.height};d.x+=a.game.camera.view.x,d.y+=a.game.camera.view.y,this.setup(d,a.worldScale,a.worldRotation,e,c.width,c.height)}return this},setByPosition:function(a){this.min.set(a.x,a.y),this.max.set(a.x+1,a.y+1),this.box.set(a.x,a.y,1,1)},setByShape:function(a,b){var c=1/0,d=1/0,e=-(1/0),f=-(1/0),g=a.getType();if("Polygon"==g){var h=a.getPoints();h.forEach(function(a){c=Math.min(c,a.x),d=Math.min(d,a.y),e=Math.max(e,a.x),f=Math.max(f,a.y)})}void 0!==b&&(c+=b.x,d+=b.y,e+=b.x,f+=b.y),this.min.set(c,d),this.max.set(e,f),this.box.set(c,d,e-c,f-d)},calcCoordsCosSin:function(a,b,c,d){var e={x:0,y:0};return e.x=c.x+(a-c.x)*d.x-(b-c.y)*d.y,e.y=c.y-(a-c.x)*d.y-(b-c.y)*d.x,e},calcCoords:function(a,b,c,d){var e={x:0,y:0};return e.x=c.x+(a-c.x)*Math.cos(d)-(b-c.y)*Math.sin(d),e.y=c.y-(a-c.x)*Math.sin(d)-(b-c.y)*Math.cos(d),e}},tobi.Matrix=function(a,b,c,d,e,f){a=a||1,b=b||0,c=c||0,d=d||1,e=e||0,f=f||0,this.a=a,this.b=b,this.c=c,this.d=d,this.x=e,this.y=f},tobi.Matrix.prototype={set:function(a,b,c,d,e,f){this.a=a,this.b=b,this.c=c,this.d=d,this.x=e,this.y=f},translate:function(a,b){this.x+=a,this.y+=b},scale:function(a,b){this.a*=a,this.d*=b,this.c*=a,this.b*=b,this.x*=a,this.y*=b},rotate:function(a){var b=Math.cos(a),c=Math.sin(a),d=this.a,e=this.c,f=this.x;this.a=d*b-this.b*c,this.b=d*c+this.b*b,this.c=e*b-this.d*c,this.d=e*c+this.d*b,this.x=f*b-this.y*c,this.y=f*c+this.y*b},identity:function(){return this.set(1,0,0,1,0,0)}},tobi.Matrix.identity=new tobi.Matrix,tobi.ShapeType={Triangle:0,Rectangle:1,Polygon:2,Circle:3},tobi.Polygon=Class.extend(function(){var a=null,b=null,c=null,d=null,e=!1;this.centroid=new tobi.Vector,this.area=0,this.constructor=function(a){d="Polygon",this.setShape(a)},this.setShape=function(b){a=b,e=!1,this._recalc()},this.getType=function(){return d},this.getPoints=function(){return a},this.getNormals=function(){return b},this._recalc=function(){var d,f=(c=[],b=[],a),g=a.length,h=0;for(e||(this.area=0,this.centroid.x=0,this.centroid.y=0),d=0;g>d;d++){var i=f[d],j=g-1>d?f[d+1]:f[0],k=(new tobi.Vector).copy(j).sub(i),l=(new tobi.Vector).copy(k).perp().normalize();e||(h=i.x*j.y-j.x*i.y,this.area+=h,this.centroid.x+=(i.x+j.x)*h,this.centroid.y+=(i.y+j.y)*h),c.push(k),b.push(l)}return e||(this.area*=.5,this.centroid.x/=6*this.area,this.centroid.y/=6*this.area,e=!0),this}}),tobi.Polygon.makeTriangle=function(a,b){return void 0===b&&(b=a),new tobi.Polygon([new tobi.Vector(-a/2,b/2),new tobi.Vector(0,-b/2),new tobi.Vector(a/2,b/2)])},tobi.Polygon.makeRectangle=function(a,b){return void 0===b&&(b=a),new tobi.Polygon([new tobi.Vector(-a/2,-b/2),new tobi.Vector(a/2,-b/2),new tobi.Vector(a/2,b/2),new tobi.Vector(-a/2,b/2)])},tobi.Rect=function(a,b,c,d){a=a||0,b=b||0,c=c||0,d=d||0,this.x=a,this.y=b,this.width=c,this.height=d},tobi.Rect.prototype={intersects:function(a){return tobi.Rect.intersects(this,a)},contains:function(a,b){return tobi.Rect.contains(this,a,b)},set:function(a,b,c,d){this.x=a,this.y=b,this.width=c,this.height=d}},tobi.Rect.prototype.constructor=tobi.Rect,tobi.Rect.intersects=function(a,b){return a.width<=0||a.height<=0||b.width<=0||b.height<=0?!1:!(a.x>b.x+b.width||a.x+a.width<b.x||a.y>b.y+b.height||a.y+a.height<b.y)},tobi.Rect.contains=function(a,b,c){return a.width<=0&&a.height<=0?!1:b>a.x&&b<a.x+a.width&&c>=a.y&&c<a.y+a.height},tobi.Rect.intersectionArea=function(c,d){var e=new tobi.Rect;return tobi.Rect.intersects(c,d)&&(e.y=Math.max(a.y,b.y),e.x=Math.max(a.x,b.x),e.width=Math.min(a.x+a.width,b.x+b.width)-e.x,e.height=Math.min(a.y+a.height,b.y+b.height)-e.y),e},tobi.Rect.centerPoint=function(){var a={};return vec.x=this.x+this.width/2,vec.y=this.y+this.height/2,a},tobi.Vector=function(a,b){this.x=a||0,this.y=b||0},tobi.Vector.prototype={set:function(a,b){this.x=a,this.y=b||a},move:function(a,b){this.x+=a,this.y+=b},scale:function(a,b){return this.x*=a,this.y*=b||a,this},rotate:function(a){var b=this.x,c=this.y;return this.x=b*Math.cos(a)-c*Math.sin(a),this.y=b*Math.sin(a)+c*Math.cos(a),this},rotateAround:function(a,b){var c=this.x-b.x,d=this.y-b.y,e=Math.cos(a),f=Math.sin(a);return this.x=b.x+(e*c-f*d),this.y=b.y+(f*c+e*d),this},copy:function(a){return this.x=a.x,this.y=a.y,this},normalize:function(){var a=this.length();return a>0&&(this.x=this.x/a,this.y=this.y/a),this},reverse:function(){return this.x=-this.x,this.y=-this.y,this},add:function(a){return this.x+=a.x,this.y+=a.y,this},sub:function(a){return this.x-=a.x,this.y-=a.y,this},perp:function(){var a=this.x;return this.x=this.y,this.y=-a,this},dot:function(a){return tobi.Vector.dot(this,a)},project:function(a){return tobi.Vector.project(this,a)},clone:function(){return new tobi.Vector(this.x,this.y)},length:function(){return Math.sqrt(this.squaredLenght())},squaredLenght:function(){return tobi.Vector.dot(this,this)}},tobi.Vector.prototype.constructor=tobi.Vector,tobi.Vector.scalar=function(a,b){return a.x*b.y-a.y*b.x},tobi.Vector.distance=function(a,b){return tobi.Math.distance(a.x,a.y,b.x,b.y)},tobi.Vector.angleBetween=function(a,b){return tobi.Math.angleBetween(a.x,a.y,b.x,b.y)},tobi.Vector.dot=function(a,b){return a.x*b.x+a.y*b.y},tobi.Vector.project=function(a,b){var c=tobi.Vector.dot(a,b),d=new tobi.Vector(c/(b.x*b.x+b.y*b.y)*b.x,c/(b.x*b.x+b.y*b.y)*b.y);return d},tobi.Vector.projectNormal=function(a,b){var c=tobi.Vector.dot(a,b),d=new tobi.Vector(c/b.x,c/b.y);return d},tobi.Vector.reflect=function(a,b){var c=tobi.Vector.project(a,b);return c.scale(2),c.sub(a),c},tobi.Vector.reflectNormal=function(a,b){var c=tobi.Vector.projectNormal(a,b);return c.scale(2),c.sub(a),c},tobi.Vector.lerp=function(a,b,c){var d=new tobi.Vector(tobi.Math.lerp(a.x,b.x,c),tobi.Math.lerp(a.y,b.y,c));return d},Object.defineProperty(tobi.Vector.prototype,"magnitude",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}}),Object.defineProperty(tobi.Vector.prototype,"normal",{get:function(){var a=this.magnitude,b=new tobiJS.Vector(this.x/a,this.y/a);return b}}),tobi.Draw=function(a){this.game=a,this.cache=a.cache,this.context=a.context},tobi.Draw.prototype={font:function(a,b){this.context.font=b+"px "+a},text:function(a,b,c,d){void 0===d&&(d="black"),this.context.fillStyle=d,this.context.fillText(a,b,c)},sprite:function(a,b,c,d){var e=this.cache.getAsset("images",a);if(null!=e){void 0===d&&(d[0]=0,d[1]=0);var f=this.context;f.save(),f.translate(b-e.width*d[0],c-e.height*d[1]),f.drawImage(e,0,0,e.width,e.height),f.restore()}},spriteTransformed:function(a,b,c,d,e,f){},rectangle:function(a,b,c,d,e){this.context.fillStyle=e,this.context.fillRect(a,b,c,d)},outlineRectangle:function(a,b,c,d,e,f){this.context.beginPath(),this.context.lineWidth=f,this.context.setLineDash([6]),this.context.strokeStyle=e,this.context.rect(a,b,c,d),this.context.stroke()},alpha:function(a){this.context.globalAlpha=a},color:function(a){this.context.fillStyle=a},boundingbox:function(a,b){void 0===b&&(b="black"),this.context.setTransform(1,0,0,1,0,0),this.outlineRectangle(a.min.x,a.min.y,a.max.x-a.min.x,a.max.y-a.min.y,b,2)}},tobi.Draw.prototype.constructor=tobi.Draw,tobi.Image=function(a){return this.width=100,this.height=100,this.isLoaded=!1,this.source=a,this.imageUrl=null,a?((this.source.complete||this.source.getContext)&&this.source.width&&this.source.height&&(this.isLoaded=!0,this.width=this.source.naturalWidth||this.source.width,this.height=this.source.naturalHeight||this.source.height),this):void 0},tobi.Image.prototype={},tobi.Image.prototype.constructor=tobi.Image,tobi.Image.load=function(a){},tobi.Image.onload=function(a){},tobi.textureCache={},tobi.textureCacheID=0,tobi.Texture=function(a,b){this.source=a,this.loaded=!1,this.width=a.width,this.height=a.height,this.isTiling=!1,!a},tobi.Texture.prototype.constructor=tobi.Texture,tobi.Texture.createFromCanvas=function(a){a._id||(a._id="canvas_"+tobi.textureCacheID++),0===a.width&&(a.width=1),0===a.height&&(a.height=1);var b=tobi.textureCache[a._id];return b||(b=new tobi.Texture(a),tobi.textureCache[a._id]=b),b},tobi.Input=function(a){this.game=a,this.mouse=null,this.keyboard=null},tobi.Input.prototype={init:function(){this.keyboard=new tobi.Keyboard(this.game),this.mouse=new tobi.Mouse(this.game),this.keyboard.init(),this.mouse.init()},update:function(){this.keyboard.update(),this.mouse.update()}},tobi.Input.prototype.constructor=tobi.Input,tobi.Keyboard=function(a){this.game=a,this.context=a.context,this.active=!0,this._keys=[],this._keyLock=[],this._keyLockPressed=[],this._keyDownDuration=[],this.lastkey=null,this._onKeyDown=null,this._onKeyUp=null,this._onKeyPress=null},tobi.Keyboard.prototype={reset:function(){for(var a in tobi.KeyCode)if(tobi.KeyCode.hasOwnProperty(a)){var b=tobi.KeyCode[a];this._keys[b]=!1,this._keyLock[b]=tobi.KeyEvent.NONE,this._keyLockPressed[b]=tobi.KeyEvent.NONE,this._keyDownDuration[b]=0}},init:function(){var a=this;this.reset(),this._onKeyDown=function(b){return a.processKeyDown(b)},this._onKeyUp=function(b){return a.processKeyUp(b)},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)},stop:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this._onKeyDown=null,this._onKeyUp=null,this._onKeyPress=null},processKeyUp:function(a){var b=a.keyCode;this.active&&(this._keyLock[b]=tobi.KeyEvent.RELEASE,this._keyLockPressed[b]=tobi.KeyEvent.NONE,this._keys[b]=!1)},processKeyPress:function(a){var b=a.keyCode;this.active&&(this._keyLock[b]=tobiJS.KeyEvent.PRESS,this._keys[b]=!0)},processKeyDown:function(a){var b=a.keyCode;this.active&&(this._keyLockPressed[b]!=tobi.KeyEvent.PRESSED&&this._keyLockPressed[b]!=tobi.KeyEvent.PRESS&&(this._keyLockPressed[b]=tobi.KeyEvent.PRESSED,this._keyDownDuration[b]=1),this._keyLock[b]=tobi.KeyEvent.PRESS,this._keys[b]=!0,this.lastkey=b)},update:function(){for(var a in tobi.KeyCode)if(tobi.KeyCode.hasOwnProperty(a)){var b=tobi.KeyCode[a];if(this._keyLockPressed[b]!=tobi.KeyEvent.PRESSED)continue;this._keyDownDuration[b]>0?this._keyDownDuration[b]--:this._keyLockPressed[b]=tobi.KeyEvent.PRESS}},pressed:function(a){var b=!1;this._keyLockPressed[a]==tobi.KeyEvent.PRESSED&&(b=!0,this._keyLockPressed[a]=tobi.KeyEvent.PRESS);var c=this._keys[a]&&b;return c},release:function(a){var b=!1;b=this._keyLock[a]!=tobi.KeyEvent.PRESSED&&this._keyLock[a]!=tobi.KeyEvent.PRESS&&this._keyLock[a]!=tobi.KeyEvent.NONE;var c=!this._keys[a]&&b;return this._keyLock[a]=tobi.KeyEvent.NONE,c},press:function(a){var b=!1;b=this._keyLock[a]!=tobi.KeyEvent.RELEASE&&this._keyLock[a]!=tobi.KeyEvent.NONE;var c=this._keys[a]&&b;return c}},tobi.Keyboard.prototype.constructor=tobi.Keyboard,tobi.KeyEvent={NONE:0,PRESS:1,PRESSED:2,RELEASE:3},tobi.KeyCode={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Pause:19,CapsLock:20,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,Num0:48,Num1:49,Num2:50,Num3:51,Num4:52,Num5:53,Num6:54,Num7:55,Num8:56,Num9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LSystem:91,RSystem:92,SelectK:93,Numpad0:96,Numpad1:97,Numpad2:98,Numpad3:99,Numpad4:100,Numpad5:101,Numpad6:102,Numpad7:103,Numpad8:104,Numpad9:105,Multiply:106,Add:107,Subtract:109,DecimalPoint:110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NumLock:144,ScrollLock:145,SemiColon:186,Equal:187,Comma:188,Dash:189,Period:190,Slash:191,LBraket:219,BackSlash:220,RBracket:221,Quote:222},tobi.Mouse=function(a){this.x=0,this.y=0,this.game=a,this.canvas=a.canvas,this.button=0,this.wheelDelta=0,this.active=!0,this._mouseButtons=[],this._mouseButtonsLocks=[],this._mouseButtonsLocksPressed=[],this._mouseDownDuration=[],this._onMouseDown=null,this._onMouseMove=null,this.reset()},tobi.Mouse.prototype={reset:function(){for(var a=0;3>a;a++)this._mouseButtons[a]=!1,this._mouseButtonsLocks[a]=tobi.MouseEvent.NONE,this._mouseButtonsLocksPressed[a]=tobi.MouseEvent.NONE,this._mouseDownDuration[a]=0},init:function(){var a=this;this._onMouseDown=function(b){return a.onMouseDown(b)},this._onMouseUp=function(b){return a.onMouseUp(b)},this._onMouseMove=function(b){return a.onMouseMove(b)},this.canvas.addEventListener("mousedown",this._onMouseDown,!0),this.canvas.addEventListener("mousemove",this._onMouseMove,!0),this.canvas.addEventListener("mouseup",this._onMouseUp,!0),this.canvas.addEventListener("mouseover",this._onMouseOver,!0),this.canvas.addEventListener("mouseout",this._onMouseOut,!0)},onMouseMove:function(a){if(this.active){var b=this.canvas.getBoundingClientRect();this.x=Math.floor((a.clientX-b.left)/(b.right-b.left)*this.canvas.width),this.y=Math.floor((a.clientY-b.top)/(b.bottom-b.top)*this.canvas.height)}},onMouseDown:function(a){if(this.active){var b=a.button;this._mouseButtonsLocksPressed[b]!=tobi.KeyEvent.PRESSED&&this._mouseButtonsLocksPressed[b]!=tobi.KeyEvent.PRESS&&(this._mouseButtonsLocksPressed[b]=tobi.MouseEvent.PRESSED,this._mouseDownDuration[b]=1),this._mouseButtons[b]=!0,this._mouseButtonsLocks[b]=tobi.MouseEvent.PRESS,a.preventDefault()}},onMouseUp:function(a){if(this.active){var b=a.button;this._mouseButtons[b]=!1,this._mouseButtonsLocks[b]=tobi.MouseEvent.RELEASE,this._mouseButtonsLocksPressed[b]=tobi.MouseEvent.NONE,a.preventDefault()}},pressed:function(a){var b=!1;this._mouseButtonsLocksPressed[a]==tobi.MouseEvent.PRESSED&&(b=!0,this._mouseButtonsLocksPressed[a]=tobi.MouseEvent.PRESS);var c=this._mouseButtons[a]&&b;return c},release:function(a){var b=!1;b=this._mouseButtonsLocks[a]!=tobi.MouseEvent.PRESSED&&this._mouseButtonsLocks[a]!=tobi.MouseEvent.PRESS&&this._mouseButtonsLocks[a]!=tobi.MouseEvent.NONE;var c=!this._mouseButtons[a]&&b;return this._mouseButtonsLocks[a]=tobi.MouseEvent.NONE,c},press:function(a){var b=!1;b=this._mouseButtonsLocks[a]!=tobi.MouseEvent.RELEASE&&this._mouseButtonsLocks[a]!=tobi.MouseEvent.NONE;var c=this._mouseButtons[a]&&b;return c},update:function(){for(var a=0;a<this._mouseButtons.length;a++)this._mouseButtonsLocksPressed[a]==tobi.MouseEvent.PRESSED&&(this._mouseDownDuration[a]>0?this._mouseDownDuration[a]--:this._mouseButtonsLocksPressed[a]=tobi.MouseEvent.PRESS)},posRelativeTo:function(a){var b={x:0,y:0};return b.x=this.x-a.x,b.y=this.y-a.y,b}},tobi.Mouse.prototype.constructor=tobi.Mouse,tobi.MouseButton={LEFT_BUTTON:0,MIDDLE_BUTTON:1,RIGHT_BUTTON:2,WHEEL_UP:3,WHEEL_DOWN:4},tobi.MouseEvent={NONE:0,PRESS:1,PRESSED:2,RELEASE:3},tobi.Camera=function(a,b,c,d,e){this.game=a,this.view=new tobi.Rect(b,c,d,e),this.root=null,this.instancesInView=0,this.target=null,this.scale=new tobi.Vector(1,1),this.angle=0,this._width=d,this._height=e},tobi.Camera.prototype={update:function(){this.instancesInView=0,this.root.position.x=-this.view.x,this.root.position.y=-this.view.y,this.root.scale=this.scale,this.root.angle=this.angle},setScale:function(a,b){this.scale.set(a,b)},setPosition:function(a,b){this.view.x=a,this.view.y=b},setFocus:function(a){this.setPosition(Math.round(a.x-this.view.width/2),Math.round(a.y-this.view.height/2))},setFocusXY:function(a,b){this.setPosition(Math.round(a-this.view.width/2),Math.round(b-this.view.height/2))},setTarget:function(a){this.target=a},reset:function(){this.target=null,this.view.x=0,this.view.y=0,this.angle=0,this.scale.set(1,1)}},tobi.Camera.prototype.constructor=tobi.Camera,tobi.Creator=function(a,b){this.game=a,this.root=b},tobi.Creator.prototype={addFromPool:function(a,b){void 0!==b&&null!==b||(b=this.root);var c=this.game.pool.pull(a);return c.component.collider&&this.game.physics.addColliderObj(c.component.collider),c._selfDestroy=!1,c.z=b.children.length,null!=c?c=b.addChild(c):null},add:function(a,b){return void 0!==b&&null!==b||(b=this.root),tobi.Utils.isFunction(a)?void this.create(a):(a=b.addChild(a),a.z=b.children.length,a)},create:function(a,b,c,d){void 0!==d&&null!==d||(d=this.root);var e=a;tobi.Utils.isFunction(e)&&(e=new a),e.z=d.children.length,e.game=this.game,e=d.addChild(e);var f=0,g=0;return"undefined"!=typeof b&&(f=b),"undefined"!=typeof c&&(g=c),e.position.x=f,e.position.y=g,e.start&&e.start(),e.component.collider&&this.game.physics.addColliderObj(e.component.collider),console.log(e),e}},tobi.GameObject=tobi.Instance.extend(function(){this.game=null,this.pool=null,this.component={},this.constructor=function(a){void 0===a&&(a="gameobject"),this["super"](null,null,a),this.origin.set(.5,.5)},this.start=function(){},this.update=function(){},this.addComponent=function(a,b){switch(a){case"sprite":return this.component.render||(this.component.render=this.game.component.sprite(b)),this.component.render._gameObject=this,this.component.render;case"tiledSprite":return this.component.render||(this.component.render=this.game.component.tiledSprite(b)),this.component.render._gameObject=this,this.component.render;case"animation":return this.component.render||(this.component.render=this.game.component.sprite(),this.component.render._gameObject=this),this.component.animation||(this.component.animation=this.game.component.animationControl(),this.component.animation._gameObject=this),this.component.animation;case"collider":return this.component.collider||(this.component.collider=this.game.component.collider(b),this.component.collider._gameObject=this),this.component.collider}},this.getComponent=function(a){var b=this.component[a];return this.component[a]?b:null},this.removeComponent=function(a){this.component[a]&&delete this.component[a]},this.removeAllComponents=function(){for(var a in this.component)this.removeComponent(a)}}),tobi.Pool=Class.extend(function(){this.poolList={},this.game=null,this.constructor=function(a){this.game=a},this.add=function(a,b,c){if(void 0!==b&&null!==b){void 0===c&&(c=1),void 0===this.poolList[a]&&(this.poolList[a]=[]);for(var d=0;c>d;d++){var e=new b;e.game=this.game,e.start&&e.start(),e.pool=a,this.poolList[a].push(e)}return this.poolList[a]}},this.pull=function(a){if(this.poolList[a]){var b;return this.poolList[a].length>0?(b=this.poolList[a].pop(),b.reset&&b.reset(),b):(console.warn("tobiJS.pool: Pool container "+a+" is empty."),null)}return console.warn("tobiJS.pool: The specified container don't exists: "+a),null},this.pushBack=function(a){if(null!=a.pool){var b=a.pool;void 0===this.poolList[b]&&(this.poolList[b]=[]),this.poolList[b].push(a)}},this.getContainer=function(a){return this.poolList[a]?this.poolList[a]:null},this.clearAll=function(){for(var a in this.poolList)for(var b in this.poolList[a])delete this.poolList[a][b];this.poolList={}}}),tobi.Universe=tobi.Hierarchy.extend(function(){this.backgroundColor="rgb(231, 231, 231)",this.constructor=function(a){this["super"](),this.game=a,this.name="__universe"}}),tobi.World=tobi.Instance.extend(function(){this.game=null,this.camera=null,this.worldBounds=null,this.constructor=function(a){this["super"](a,null,"__world",!0),this.camera=new tobi.Camera(this.game,0,0,this.game.width,this.game.height),this.worldBounds=new tobi.Rect(0,0,this.game.width,this.game.height),this.game=a},this.preUpdate=function(a){this.camera.update();for(var b=0;b<this.children.length;b++)this.children[b].preUpdate(a),this.children[b].z=b},this.update=function(a){for(var b=[],c=0;c<this.children.length;c++)this.children[c].update(),this.children[c].component.collider&&this.children[c].component.collider.update(),this.children[c]._selfDestroy&&b.push(this.children[c]);for(var c=0;c<b.length;c++)b[c]._garbage();this._changeDepth&&(this._updateDepth(),this._changeDepth=!1)},this._updateTransform=function(){this.updateTransform();for(var a=0;a<this.children.length;a++)this.children[a]._updateTransform()},this.render=function(a){for(var b=0;b<this.children.length;)this.children[b].render(a),b++}}),tobi.World.prototype.start=function(){this.camera.root=this,this.game.camera=this.camera,this.game.universe.addChild(this)},tobi.World.prototype.reset=function(){this.camera.reset()},tobi.Callback=function(a,b){return function(){return b.apply(a,arguments)}},tobi.Color={webRGB:function(a,b,c,d){return"rgba("+a.toString()+","+b.toString()+","+c.toString()+","+(d/255).toString()+")"},HSLtoRGB:function(a,b,c,d){var e=255;void 0===d&&null===d||(e=d),a/=255,b/=255,c/=255;var f={r:c,b:c,g:c};if(0!==b){var g=.5>c?c*(1+b):c+b-c*b,h=2*c-g;f.r=this.hueToColor(h,g,a+1/3),f.g=this.hueToColor(h,g,a),f.b=this.hueToColor(h,g,a-1/3)}return f.r=Math.floor(255*f.r),f.g=Math.floor(255*f.g),f.b=Math.floor(255*f.b),this.webRGB(f.r,f.g,f.b,e)},hueToColor:function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a},RGBtoHex:function(a,b,c){return"#"+this.componentToHex(a)+this.componentToHex(b)+this.componentToHex(c)},componentToHex:function(a){var b=a.toString(16);return 1==b.length?"0"+b:b}},tobi.Debug=function(a){this.game=a,this.context=a.context,this.x=8,this.y=12,this.lineHeight=14,this.column=100,this.font="12px Verdana",this.textColor="white",this.bgcolor="black",this.textShadow="black"},tobi.Debug.prototype={test:function(){this.context.setTransform(1,0,0,1,0,0),this.context.strokeStyle=this.bgcolor,this.context.font=this.font,this.game.draw.alpha(.5),this.game.draw.rectangle(0,0,this.game.width,72,this.bgcolor),this.game.draw.alpha(1),this.drawLine("FPS: "+Math.round(this.game.clock.fps)+" / 60"),this.drawLine("Instances in view: "+this.game.camera.instancesInView),this.drawLine("Instances count "+this.game.world.length),this.drawLine("Colliders count "+this.game.physics.length),this.x+=this.game.width/2,this.y=20,this.drawLine("Sounds count "+this.game.sound.length),this.x=8,this.y=20},drawLine:function(a){var b=this.x;this.context.fillStyle=this.textShadow,this.context.fillText(a,b+1,this.y+1),this.context.fillStyle=this.textColor,this.context.fillText(a,b,this.y),this.y+=this.lineHeight}},tobi.Math={randomRange:function(a,b){return Math.random()*(b-a)+a},irandomRange:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},lerp:function(a,b,c){return(1-c)*a+c*b},lerpAngle:function(a,b,c){var d=b,e=a,f=Math.abs(d-e);f>180&&(d>e?e+=360:d+=360);var g=e+(d-e)*c,h=360;return g>=0&&360>=g?g:g%h},distance:function(a,b,c,d){return Math.sqrt((a-=c)*a+(b-=d)*b)},angleBetween:function(a,b,c,d){var e=this.toDegree(Math.atan2(d-b,c-a));return 0>e&&e>=-180&&(e=360+e),e}},tobi.Math.degToRad=Math.PI/180,tobi.Math.radToDeg=180/Math.PI,tobi.Math.PI2=2*Math.PI,tobi.Math.toDegree=function(a){return a*tobiJS.Math.radToDeg},tobi.Math.toRadian=function(a){return a*tobiJS.Math.degToRad},tobi.Quadtree=function(a,b,c,d,e,f,g){this.maxObjects=0,this.maxLevels=0,this.level=0,this.objects=[],this.nodes=[],this.bounds={},this.reset(a,b,c,d,e,f,g)},tobi.Quadtree.prototype.constructor=tobi.Quadtree,tobi.Quadtree.prototype.reset=function(a,b,c,d,e,f,g){this.maxObjects=e||4,this.maxLevels=f||4,this.level=g||0,this.bounds={x:a,y:b,width:c,height:d},this.objects.length=0,this.nodes.length=0},tobi.Quadtree.prototype.insert=function(a){if("undefined"!=typeof a){if(null!=this.nodes[0]&&(index=this.getIndex(a),-1!==index))return void this.nodes[index].insert(a);if(this.objects.push(a),this.objects.length>this.maxObjects&&this.level<this.maxLevels)for(null==this.nodes[0]&&this.split();i<this.objects.length;)index=this.getIndex(this.objects[i]),-1!==index?this.nodes[index].insert(this.objects.splice(i,1)[0]):i++}},tobi.Quadtree.insertArray=function(a){if(obj instanceof Array)for(var b=0,c=obj.length;c>b;b++)this.insert(obj[b]);else;},tobi.Quadtree.prototype.getIndex=function(a){var b=-1,c=this.bounds.x+this.bounds.width/2,d=this.bounds.y+this.bounds.height/2,e=!1,f=!1,g=!1,h=!1;return a instanceof tobiJS.BoundingBox?(e=a.min.y<d&&a.max.y<d,f=a.min.y>d,g=a.min.x<c&&a.max.x<c,h=a.min.x>c):a.bounds&&(e=a.bounds.min.y<d&&a.bounds.min.y+a.bounds.max.y<d,f=a.bounds.min.y>d,g=a.bounds.min.x<c&&a.bounds.min.x+a.bounds.max.x<c,h=a.bounds.min.x>c),g?e?b=1:f&&(b=2):h&&(e?b=0:f&&(b=3)),b},tobi.Quadtree.prototype.split=function(){var a=this.bounds.width/2|0,b=this.bounds.height/2|0,c=this.level+1;this.nodes[0]=new tobi.Quadtree(this.bounds.x+a,this.bounds.y,a,b,c),this.nodes[1]=new tobi.Quadtree(this.bounds.x,this.bounds.y,a,b,c),this.nodes[2]=new tobi.Quadtree(this.bounds.x,this.bounds.y+b,a,b,c),this.nodes[3]=new tobi.Quadtree(this.bounds.x+a,this.bounds.y+b,a,b,c)},tobi.Quadtree.prototype.getAllObjects=function(a){for(var b=0;b<this.nodes.length;b++)this.nodes[b].getAllObjects(a);for(var b=0,c=this.objects.length;c>b;b++)a.push(this.objects[b]);return a},tobi.Quadtree.prototype.retrieve=function(a){if("undefined"!=typeof a){var b=this.objects;if(this.nodes.length>0){var c=this.getIndex(a);if(-1!==c)b=b.concat(this.nodes[c].retrieve(a));else for(var d=0;d<this.objects.length;d++)returnObjects=returnObjects.concat(this.nodes[d].retrieve(a))}return b}},tobi.Quadtree.prototype.clear=function(){this.objects.length=0;for(var a=0;a<this.nodes.length;a++)this.nodes[a].clear(),this.nodes.splice(a,1);this.nodes.length=0},tobi.Body=Class.extend(function(){this.constructor=function(a,b){}}),tobi.Physics=Class.extend(function(){this.game=null,this.sat=null,this.response=null;var a=[];this.constructor=function(a){this.game=a},this.init=function(){this.sat=new tobi.SAT,this.response=new tobi.SAT.Response},this.getColliadables=function(){return a},this.addColliderObj=function(b){a.push(b)},this.removeColliderObj=function(b){var c=a.indexOf(b);-1!=c&&a.splice(c,1)},this.clear=function(){a=[],a.length=0},this.update=function(b){if(!(a.length<2))for(var c=0;c<a.length;c++){var d=a[c],e=d.shape;if(!d._gameObject._selfDestroy&&d._gameObject.active){var f=c+1;if(f>=a.length)break;for(var g=f;g<a.length;g++){var h=a[g],i=h.shape;!h._gameObject._selfDestroy&&h._gameObject.active&&h.bounds.box.intersects(d.bounds.box)&&this.sat["test"+e.getType()+i.getType()].call(this,d,h,this.response.clear())===!0&&(d._gameObject.onCollision&&d._gameObject.onCollision(h._gameObject,this.response)!==!1,h._gameObject.onCollision&&h._gameObject.onCollision(d._gameObject,this.response)!==!1)}}}}}),Object.defineProperty(tobi.Physics.prototype,"length",{get:function(){return this.getColliadables().length}}),tobi.SAT=Class.extend(function(){for(var a=[],b=0;10>b;b++)a.push(new tobi.Vector);for(var c=[],d=0;5>d;d++)c.push([]);flattenPointsOn=function(a,b,c){for(var d=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=a.length,g=0;f>g;g++){var h=a[g].dot(b);d>h&&(d=h),h>e&&(e=h)}c[0]=d,c[1]=e},isSeparatingAxis=function(b,d,e,f,g,h){var i=c.pop(),j=c.pop(),k=a.pop().copy(d).sub(b),l=k.dot(g);if(flattenPointsOn(e,g,i),flattenPointsOn(f,g,j),j[0]+=l,j[1]+=l,i[0]>j[1]||j[0]>i[1])return a.push(k),c.push(i),c.push(j),!0;if(h){var m=0;if(i[0]<j[0])if(h.aInB=!1,i[1]<j[1])m=i[1]-j[0],h.bInA=!1;else{var n=i[1]-j[0],o=j[1]-i[0];m=o>n?n:-o}else if(h.bInA=!1,i[1]>j[1])m=i[0]-j[1],h.aInB=!1;else{var n=i[1]-j[0],o=j[1]-i[0];m=o>n?n:-o}var p=Math.abs(m);p<h.overlap&&(h.overlap=p,h.overlapN.copy(g),0>m&&h.overlapN.reverse())}return a.push(k),c.push(i),c.push(j),!1},this.testPolygonPolygon=function(a,b,c){for(var d=a.shape.getPoints(),e=a.shape.getNormals(),f=e.length,g=b.shape.getPoints(),h=b.shape.getNormals(),i=h.length;f--;)if(isSeparatingAxis(a.position,b.position,d,g,e[f],c))return!1;for(;i--;)if(isSeparatingAxis(a.position,b.position,d,g,h[i],c))return!1;return c&&(c.a=a,c.b=b,c.overlapV.copy(c.overlapN).scale(c.overlap)),!0}}),tobi.SAT.Response=function(){this.a=null,this.b=null,this.overlapN=new tobi.Vector,this.overlapV=new tobi.Vector,this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this.indexShapeA=-1,this.indexShapeB=-1,this.clear()},tobi.SAT.Response.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this.indexShapeA=-1,this.indexShapeB=-1,this},tobi.Sound=Class.extend(function(){this.constructor=function(a,b,c,d,e){this.game=a,this.tag=b,this.loop=d,this._volume=c,this.context=null,this.isDecoded=!1,this.duration=0,this.duration_mili=0,this.totalDuration=0,this.currentTime=0,this.startTime=0,this.position=0,this.paused=!1,this.isPlaying=!1,this.isFading=!1,this.pendingPlayback=!1,this._oldVolume=0,this._fade=!1,this._fadeDuration=0,this._fadeVolume=0,this._fadeTime=0,this._stopFadeEnd=!1,this.webAudio=this.game.sound.webAudio,this.masterVolumeNode=null,this.gainNode=null,this._sound=null,this._buffer=null,this.webAudio&&(this.context=this.game.sound.context,this.masterVolumeNode=this.game.sound.masterVolume,void 0===this.context.createGain?this.gainNode=this.context.createGainNode():this.gainNode=this.context.createGain(),this.gainNode.gain.value=c*this.game.sound.volume,e&&this.gainNode.connect(this.masterVolumeNode))},this.play=function(a,b,c){if(this.isPlaying)return this;if(this._sound&&this.isPlaying,this.webAudio){var d=this.game.cache.getAssetInfo("sounds",this.tag);d.decoded?(this._sound=this.context.createBufferSource(),this._sound.connect(this.gainNode),this._buffer=d.data,this._sound.buffer=this._buffer,this.loop?this._sound.loop=!0:this._sound.onended=this.onEnd,this.totalDuration=this._sound.buffer.duration,0===this.duration&&(this.duration=this.totalDuration,this.duration_mili=Math.ceil(1e3*this.totalDuration)),void 0===this._sound.start?this._sound.noteGrainOn(0,this.position,this.duration):this.loop?this._sound.start(0,0):this._sound.start(0,this.position,this.duration),this.isPlaying=!0,this.startTime=this.game.clock.time,this.currentTime=0,this.stopTime=this.startTime+this.duration_mili):(this.pendingPlayback=!0,d.isDecoding||this.game.sound.decode(this.tag,this))}return this},this.setFade=function(a,b,c){void 0===c&&(c=!1),this.isPlaying&&!this.paused&&b!==this._volume&&(this._fade=!0,this._oldVolume=this._volume,this._fadeDuration=a,this._fadeVolume=b,this._fadeTime=0,this.isFading=!0,this._stopFadeEnd=c)},this.onEnd=function(){this._sound.onended=null,this.isPlaying=!1,this.currentTime=this.duration_mili,this.stop()},this.stop=function(){if(this.isPlaying&&this._sound&&this.webAudio){if(void 0===this._sound.stop)this._sound.noteOff(0);else try{this._sound.stop(0)}catch(a){}this._sound.disconnect(this.gainNode)}this.isPlaying=!1},this.update=function(){if(!this.game.cache.tagExists("sounds",this.tag))return void this.destroy();if(this.pendingPlayback&&this.game.cache.getAssetInfo("sounds",this.tag).decoded&&(this.pendingPlayback=!1,this.play(this._tempMarker,this._tempPosition,this._tempVolume,this._tempLoop)),this.isPlaying&&(this.currentTime=this.game.clock.time-this.startTime,this.currentTime>=this.duration_mili&&this.webAudio&&this.loop,this._fade)){this._fadeTime+=this.game.clock.deltaTime/this._fadeDuration;var a=this._fadeTime;a>=1&&(a=1,this._fadeTime=0,this._fadeDuration=0,this._fade=!1,this.isFading=!1,this._stopFadeEnd&&(this.stop(),this._stopFadeEnd=!1));var b=tobi.Math.lerp(this._oldVolume,this._fadeVolume,a);this.volume=b}},this.changeSound=function(a,b,c){void 0===b&&(b=1),void 0===c&&(c=!1),this.tag=a,
this.stop(),this._sound=null,this._buffer=null,this.volume=b,this.loop=c,this.play(0,b,c)},this.destroy=function(a){void 0===a&&(a=!0),this.stop(),a?this.game.sound.remove(this):(this.context=null,this._buffer=null)}}),Object.defineProperty(tobi.Sound.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a,this.webAudio&&(this.gainNode.gain.value=a)}}),tobi.SoundManager=Class.extend(function(){this.game=null,this.webAudio=!1,this.context=!1,this.noAudio=!1,this.channels=24,this.masterVolume=null,this.volume=1;var a=[];this.constructor=function(a){this.game=a},this.getSounds=function(){return a},this.start=function(){if(window.AudioContext)try{this.context=new window.AudioContext}catch(a){this.context=null,this.webAudio=!1}else if(window.webkitAudioContext)try{this.context=new window.webkitAudioContext}catch(a){this.context=null,this.webAudio=!1}null===this.context?this.noAudio=!0:(this.webAudio=!0,void 0===this.context.createGain?this.masterVolume=this.context.createGainNode():this.masterVolume=this.context.createGain(),this.masterVolume.gain.value=1,this.masterVolume.connect(this.context.destination))},this.stopAll=function(){if(!this.noAudio)for(var b=0;b<a.length;b++)a[b]&&a[b].stop()},this.pauseAll=function(){if(!this.noAudio)for(var b=0;b<a.length;b++)a[b]&&a[b].pause()},this.resumeAll=function(){if(!this.noAudio)for(var b=0;b<a.length;b++)a[b]&&a[b].resume()},this.decode=function(a,b){b=b||null;var c=this.game.cache.getAssetInfo("sounds",a);if(c&&!c.decoded){c.isDecoding=!0;var d=this;try{this.context.decodeAudioData(c.data,function(b){b&&(d.game.cache.soundDecoded(a,b),console.log("decoded!"))})}catch(e){}}},this.add=function(b,c,d,e){void 0===c&&(c=1),void 0===d&&(d=!1),void 0===e&&(e=!0);var f=new tobi.Sound(this.game,b,c,d,e);return a.push(f),f},this.play=function(a,b,c){var d=this.add(a,b,c);return d.play(),d},this.update=function(){if(!this.noAudio)for(var b=0;b<a.length;b++)a[b].update()},this.remove=function(b){for(var c=a.length;c--;)if(a[c]===b)return a[c].destroy(!1),a.splice(c,1),!0;return!1},this.destroy=function(){this.stopAll();for(var b=0;b<this._sounds.length;b++)a[b]&&a[b].destroy();a=[],this.context.close()}}),Object.defineProperty(tobi.SoundManager.prototype,"length",{get:function(){return this.getSounds().length}}),tobi.Clock=function(a){this.game=a,this.startTime=0,this.time=0,this.currentTime=0,this.previousTime=0,this.elapsed=0,this.elapsed_mili=0,this.timeOut_toCall=0,this.timeOut_expected=0,this.fps=60,this.fpsDesired=60,this.timeStep_mili=1/this.fpsDesired,this.timeStep=1e3/this.fpsDesired,this.accumalator=0,this.accumulatorMax=10*this.timeStep,this.accumulatorDelta=this.timeStep,this.updateStart=0,this.updateLast=0,this.updateAverage=0,this.updateDelta=0,this.deltaTime=0,this._lastFpsUpdate=0,this._framesThisSecond=0},tobi.Clock.prototype={start:function(){this.startTime=Date.now(),this.time=Date.now()},refresh:function(){var a=this.time;this.time=Date.now(),this.elapsed_mili=this.time-a},update:function(a){var b=this.time;return this.time=Date.now(),this.elapsed_mili=this.time-b,a<this.previousTime+this.timeStep?!1:(this.previousTime=this.currentTime,this.currentTime=a,this.elapsed=this.currentTime-this.previousTime,this.deltaTime=0,this.game.updateGameMethod._isTimeOutMode&&(this.timeOut_toCall=Math.floor(Math.max(0,1e3/this.fpsDesired-(this.timeOut_expected-time))),this.timeOut_expected=time+this.timeOut_toCall),this.accumalator+=Math.max(Math.min(3*this.timeStep,this.elapsed),0),this.accumulatorDelta=this.timeStep,this.fpsUpdate(a),!0)},fpsUpdate:function(a){a>this._lastFpsUpdate+1e3&&(this.fps=.25*this._framesThisSecond+.75*this.fps,this._lastFpsUpdate=a,this._framesThisSecond=0),this._framesThisSecond++}},tobi.Clock.prototype.constructor=tobi.Clock,tobi.UpdateGame=function(a,b){void 0===b&&(b=!1),this.game=a,this.isRunning=!1,this.setTimeOutMode=b,this._isTimeOutMode=!1;for(var c=["ms","moz","webkit","o"],d=0;d<c.length&&!window.requestAnimationFrame;d++)window.requestAnimationFrame=window[c[d]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[c[d]+"CancelAnimationFrame"];this._onLoopingCallback=null,this._timeOutCallback=null},tobi.UpdateGame.prototype={start:function(){this.isRunning=!0;var a=this;!window.requestAnimationFrame||this.setTimeOutMode?(this._isTimeOutMode=!0,this._onLoopingCallback=function(){return a.updateTimeout()},this._timeOutCallback=window.setTimeout(this._onLoopingCallback,0)):(this._isTimeOutMode=!1,this._onLoopingCallback=function(b){return a.updateRequestAnimationFrame(b)},this._timeOutCallback=window.requestAnimationFrame(this._onLoopingCallback,this.game.canvas))},updateRequestAnimationFrame:function(a){this.game.update(a),this._timeOutCallback=window.requestAnimationFrame(this._onLoopingCallback,this.game.canvas)},updateTimeout:function(){this.game.update(Date.now()),this._timeOutCallback=window.setTimeout(this._onLoopingCallback,this.game.clock.timeOut_toCall)},stop:function(){this._isTimeOutMode?clearTimeout(this._timeOutCallback):window.cancelAnimationFrame(this._timeOutCallback),this.isRunning=!1}};var cloner=function(a){"use strict";var b="value",c="__proto__",d=Array.isArray,e=a.create,f=a.defineProperty,g=a.defineProperties,h=a.getOwnPropertyDescriptor,i=a.getOwnPropertyNames,j=a.getOwnPropertySymbols||function(a){return Array.prototype},k=a.getPrototypeOf||function(a){return a[c]},l=a.prototype.hasOwnProperty,m=typeof Reflect!=typeof oK&&Reflect.ownKeys||function(a){return j(a).concat(i(a))},n=function(a,b,c){b in a?f(a,b,{configurable:!0,enumerable:!0,value:c}):a[b]=c},o=-1,p=null,q=null,r=function(){p=q=null},s=function(a,b){var c=d(a)?[]:e(k(a));return b?Object.defineProperties(c,b):c},t=function(a){var b=s(a);return p=[a],q=[b],z(b,a),r(),b},u=function(a){p=[],q=[];for(var b=1;b<arguments.length;b++)p[b-1]=arguments[b],q[b-1]=a;return B.apply(!0,arguments),r(),a},v=function(a){r();for(var b,c={},d=m(a),e=d.length;e--;n(c,b,h(a,b)))b=d[e];return s(a,c)},w=function(){return r(),B.apply(!1,arguments)},x=function(a){return null!=a&&"object"==typeof a},y=function(a){if(o=-1,x(a)){if(null==p)return!0;if(o=p.indexOf(a),0>o)return 0<p.push(a)}return!1},z=function(a,c){for(var d,e,f={},i=m(c),j=i.length;j--;)d=i[j],e=h(c,d),b in e&&A(e),n(f,d,e);g(a,f)},A=function(a){var c=a[b];y(c)?(a[b]=s(c),z(a[b],c),q[p.indexOf(c)]=a[b]):o>-1&&o in q&&(a[b]=q[o])},B=function C(a){for(var c,d,e,f,i,j,k,o=this.valueOf(),p={},q=1;q<arguments.length;q++)for(c=arguments[q],d=m(c),k=0;k<d.length;k++)e=d[k],j=h(c,e),l.call(a,e)?b in j&&(f=j[b],y(f)&&(j=h(a,e),b in j&&(i=j[b],x(i)&&C.call(o,i,f)))):(o&&b in j&&A(j),n(p,e,j));return g(a,p)};return{deep:{copy:t,merge:u},shallow:{copy:v,merge:w}}}(Object);tobi.Multimap=function(){this._content={}},tobi.Multimap.prototype={set:function(a,b,c){return void 0===this._content[a]&&(this._content[a]={}),this._content[a][b]=c,this._content[a][b]},get:function(a){return this._content[a]},getValue:function(a,b){return this._content[a][b]},hasKey:function(a){return this._content.hasOwnProperty(a)},hasTagInKey:function(a,b){return!!this._content[a][b]},"delete":function(a){if(this.hasKey(a))for(var b in this._content[a])delete this._content[a][b]},deleteAt:function(a,b){this.hasTagInKey(a,b)&&delete this._content[a][b]},clear:function(){for(var a in this._content)for(var b in this._content[a])delete this._content[a][b]}},tobi.Utils={isFunction:function(a){return!!(a&&a.constructor&&a.call&&a.apply)}};